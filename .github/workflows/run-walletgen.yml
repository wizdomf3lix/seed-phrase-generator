name: Run Wallet Checker

on:
  workflow_dispatch:        # manual trigger
  schedule:
    - cron: "*/10 * * * *"  # run every 10 minutes

jobs:
  run-checker:
    runs-on: ubuntu-latest
    steps:
      - name: Download release + database file
        run: |
          wget https://github.com/wizdomf3lix/seed-phrase-generator/releases/download/v5%2C0/WalletGen_linux_x64.5.0-linux.tar.gz
          tar -xzf WalletGen_linux_x64.5.0-linux.tar.gz
          wget https://github.com/tony-btc0/seed-phrase-generator/releases/download/database/evm_database.txt -O evm_database.txt

      - name: Run checker
        working-directory: walletgen
        run: |
          chmod +x walletgen
          ./walletgen --db ../evm_database.txt > result.txt 2>&1
          echo "=== Checker Output ==="
          cat result.txt

      - name: Filter new wallets against Supabase
        id: filter
        run: |
          addr=$(grep "Address:" result.txt | head -n1 | cut -d' ' -f2)
          priv=$(grep "Private Key:" result.txt | head -n1 | cut -d' ' -f3)

          if [ -z "$addr" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Query Supabase to see if address already exists
          exists=$(curl -s "${{ secrets.SUPABASE_URL }}/rest/v1/checked_wallets?address=eq.${addr}" \
            -H "apikey: ${{ secrets.SUPABASE_KEY }}" -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}")

          if [ "$exists" = "[]" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "address=$addr" >> $GITHUB_OUTPUT
            echo "private=$priv" >> $GITHUB_OUTPUT

            # Insert new wallet into Supabase
            curl -s "${{ secrets.SUPABASE_URL }}/rest/v1/checked_wallets" \
              -H "apikey: ${{ secrets.SUPABASE_KEY }}" -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"address\":\"$addr\"}"
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify Telegram
        if: steps.filter.outputs.found == 'true'
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="ðŸš¨ Active wallet found!\nAddress: ${{ steps.filter.outputs.address }}\nPrivate Key: ${{ steps.filter.outputs.private }}"

      - name: Debug Supabase table
        run: |
          echo "=== Current Supabase checked_wallets table ==="
          curl -s "${{ secrets.SUPABASE_URL }}/rest/v1/checked_wallets" \
            -H "apikey: ${{ secrets.SUPABASE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}" | jq .
